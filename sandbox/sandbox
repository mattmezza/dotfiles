#!/usr/bin/env bash

# --- Configuration ---
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SECRETS_FILE="$SCRIPT_DIR/secrets.env"
IMAGE_NAME="sandbox"
DEFAULT_DOCKERFILE="./Dockerfile"

# --- Helper: Usage/Help ---
show_help() {
    cat << EOF
Usage: sandbox [COMMAND] [NAME/PATH]

A utility to manage docker-based development sandboxes.

Commands:
  up         [NAME]  Start a new sandbox or attach to an existing one.
  stop       [NAME]  Stop a running sandbox.
  down       [NAME]  Stop AND remove a sandbox container.
  rm         [NAME]  Completely remove a sandbox container.
  attach     [NAME]  Force attach to an existing sandbox tmux session.
  build      [PATH]  Build the sandbox image. Defaults to current dir.
  status             List all sandboxes and their current state.
  completion         Output bash completion script.
  man                Install the man page for this utility.
  help               Show this help message.

Examples:
  sandbox up dev-env
  sandbox down dev-env
  source <(sandbox completion)
EOF
}

# --- Logic: Completion ---
generate_completion() {
    cat << 'EOF'
_sandbox_completions() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    opts="up stop down rm attach build status completion man help"

    if [[ ${COMP_CWORD} -eq 1 ]] ; then
        COMPREPLY=( $(compgen -W "${opts}" -- "${cur}") )
        return 0
    fi
}
complete -F _sandbox_completions sandbox
EOF
}

# --- Logic: Man Page ---
install_man() {
    local MAN_PATH="/usr/local/share/man/man1/sandbox.1"
    echo "--> Generating man page..."

    if ! command -v help2man &> /dev/null; then
        echo "Note: help2man not found. Creating manual entry from help text..."
        sudo mkdir -p /usr/local/share/man/man1
        show_help | sudo tee "$MAN_PATH" > /dev/null
    else
        help2man -N ./sandbox | sudo tee "$MAN_PATH" > /dev/null
    fi

    sudo mandb &> /dev/null
    echo "--> Done. You can now run 'man sandbox'."
}

# --- Logic: Remove ---
remove_sandbox() {
    local NAME=$1
    local FULL_NAME="sandbox-$NAME"
    [ -z "$NAME" ] && { echo "Error: Missing name."; exit 1; }

    if [ "$(docker ps -aq -f name=^/${FULL_NAME}$)" ]; then
        echo "--> Removing sandbox container: $FULL_NAME"
        docker rm -f "$FULL_NAME"
    else
        echo "--> Sandbox '$FULL_NAME' does not exist."
    fi
}

# --- Logic: Stop ---
stop_sandbox() {
    local NAME=$1
    local FULL_NAME="sandbox-$NAME"
    [ -z "$NAME" ] && { echo "Error: Missing name."; exit 1; }

    if [ "$(docker ps -q -f name=^/${FULL_NAME}$)" ]; then
        echo "--> Stopping container: $FULL_NAME..."
        docker stop "$FULL_NAME"
    else
        echo "--> Sandbox '$FULL_NAME' is not running."
    fi
}

# --- Logic: Down (Stop + RM) ---
down_sandbox() {
    local NAME=$1
    [ -z "$NAME" ] && { echo "Error: Missing name."; exit 1; }

    echo "--> Taking down sandbox: $NAME"
    stop_sandbox "$NAME"
    remove_sandbox "$NAME"
}

# --- Logic: Status (List) ---
status_sandboxes() {
    echo "Current Sandboxes:"
    docker ps -a -f name=^/sandbox- --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"
}

# --- Logic: Build Image ---
build_sandbox() {
    local CONTEXT=${1:-"."}
    echo "--> Building docker image: $IMAGE_NAME from $CONTEXT"
    if [ ! -f "$CONTEXT/Dockerfile" ] && [ ! -f "$CONTEXT" ]; then
        echo "Error: Cannot find Dockerfile in $CONTEXT"; exit 1
    fi
    docker build -t "$IMAGE_NAME" "$CONTEXT"
}

# --- Logic: Run/Create ---
run_sandbox() {
    local NAME=$1
    local FULL_NAME="sandbox-$NAME"
    [ -z "$NAME" ] && { show_help; exit 1; }

    if [ "$(docker ps -aq -f name=^/${FULL_NAME}$)" ]; then
        echo "--> Sandbox '$FULL_NAME' already exists. Switching to attach..."
        attach_sandbox "$NAME"
    else
        echo "--> Creating new sandbox: $FULL_NAME"
        local ENV_FLAG=""
        if [ -f "$SECRETS_FILE" ]; then
            ENV_FLAG="--env-file $SECRETS_FILE"
            echo "    (Config: Loaded secrets from $SECRETS_FILE)"
        fi
        docker run -it --init --name "$FULL_NAME" $ENV_FLAG --security-opt seccomp=unconfined "$IMAGE_NAME"
    fi
}

# --- Logic: Attach ---
attach_sandbox() {
    local NAME=$1
    local FULL_NAME="sandbox-$NAME"
    if [ "$(docker ps -aq -f name=^/${FULL_NAME}$)" ]; then
        [ ! "$(docker ps -q -f name=^/${FULL_NAME}$)" ] && { docker start "$FULL_NAME"; sleep 1; }
        docker exec -it "$FULL_NAME" tmux attach-session -t "$FULL_NAME" || docker exec -it "$FULL_NAME" /bin/bash
    else
        echo "Error: Sandbox '$FULL_NAME' does not exist."; exit 1
    fi
}

# --- Command Router ---
case "$1" in
    build)      build_sandbox "$2"    ;;
    up)         run_sandbox "$2"      ;;
    stop)       stop_sandbox "$2"     ;;
    down)       down_sandbox "$2"     ;;
    rm)         remove_sandbox "$2"   ;;
    attach)     attach_sandbox "$2"   ;;
    status)     status_sandboxes      ;;
    completion) generate_completion   ;;
    man)        install_man           ;;
    help|--help|-h) show_help         ;;
    *)
        if [ -z "$1" ]; then show_help; else run_sandbox "$1"; fi
        ;;
esac
