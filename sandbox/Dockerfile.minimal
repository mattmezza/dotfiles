FROM archlinux:base-devel

# UID/GID args for volume permission matching
ARG USER_UID=1000
ARG USER_GID=1000

# 1. Install minimal system dependencies (no nodejs, npm, ripgrep, gh)
RUN pacman-key --init && \
    pacman -Syu --noconfirm && \
    pacman -S --noconfirm git zsh tmux neovim stow sudo openssh curl

RUN echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# 2. Create a non-root user (to mirror your setup)
ARG USERNAME=matteo
RUN groupadd -g $USER_GID $USERNAME && \
    useradd -m -u $USER_UID -g $USER_GID -G wheel -s /bin/zsh $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
USER $USERNAME
WORKDIR /home/$USERNAME

# No AI CLIs (no opencode, no claude-code)

# Ensure ~/.local/bin is in the PATH for the session
ENV PATH="/home/matteo/.local/bin:${PATH}"

# 3. Clone and apply dotfiles (minimal: tmux, zsh only)
RUN git clone https://github.com/mattmezza/dotfiles.git dotfiles && \
    cd dotfiles && \
    stow tmux zsh

# 4. Create workspace and ssh directories with correct permissions
RUN sudo mkdir -p /workspace && \
    sudo chown $USERNAME:$USERNAME /workspace && \
    mkdir -p /home/$USERNAME/.ssh && \
    chmod 700 /home/$USERNAME/.ssh

SHELL ["/usr/bin/zsh", "-c"]
ENV TERM=xterm-256color

WORKDIR /workspace

COPY --chown=$USERNAME:$USERNAME entrypoint.sh /home/$USERNAME/entrypoint.sh
RUN chmod +x /home/$USERNAME/entrypoint.sh

ENTRYPOINT ["/home/matteo/entrypoint.sh"]
